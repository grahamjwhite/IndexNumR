---
title: "An Empirical Illustration of Index Construction using Israeli Data on Vegetables"
author: "Graham White"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
bibliography: "indexnumrbib.bib"
vignette: >
  %\VignetteIndexEntry{An Empirical Illustration of Index Construction using Israeli Data on Vegetables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(IndexNumR)
library(kableExtra)
library(ggplot2)

devtools::load_all()

```

# Month-on-month Indexes

##  Bilateral Indexes

### Chained indexes

```{r momCh, fig.width=7, fig.height=5}
methods <- c("fisher", "laspeyres", "paasche", "tornqvist", "ces", "walsh", "satovartia")

monthOnMonth <- list()
for(method in methods){
  monthOnMonth[[method]] <- IndexNumR::priceIndex(IsraeliCPI$vegetables, 
                                                  pvar = "price",
                                                  qvar = "quantity",
                                                  prodID = "prodID",
                                                  pervar = "month",
                                                  indexMethod = method,
                                                  output = "chained")
}

monthOnMonth <- data.frame(date = unique(IsraeliCPI$vegetables$date), as.data.frame(monthOnMonth)) 

monthOnMonth %>% 
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

monthOnMonth %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "Monthly Chained Price Indexes for Seven Kinds of Vegetables")

```

### Fixed base indexes

```{r momFB, fig.width=7, fig.height=5}
methods <- c("fisher", "laspeyres", "paasche", "tornqvist", "ces", "walsh", "satovartia")

monthOnMonth <- list()
for(method in methods){
  monthOnMonth[[method]] <- IndexNumR::priceIndex(IsraeliCPI$vegetables, 
                                                  pvar = "price",
                                                  qvar = "quantity",
                                                  prodID = "prodID",
                                                  pervar = "month",
                                                  indexMethod = method,
                                                  output = "fixedbase")
}

monthOnMonth <- data.frame(date = unique(IsraeliCPI$vegetables$date), as.data.frame(monthOnMonth)) 

monthOnMonth %>% 
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

monthOnMonth %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "Monthly Fixed Base Price Indexes for Seven Kinds of Vegetables")

```

## GEKS Indexes 

### Using Different Splicing Methods

```{r geksSplices, fig.width=7, fig.height=5}

splices <- c("movement", "half", "window", "mean", "fbew", "fbmw")

geksSplices <- list()
for(splice in splices){
  
  geksSplices[[splice]] <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                                                pvar = "price",
                                                qvar = "quantity",
                                                prodID = "prodID",
                                                pervar = "month",
                                                indexMethod = "fisher",
                                                window = 13,
                                                splice = splice)
  
}

geksSplices <- data.frame(date = unique(IsraeliCPI$vegetables$date), 
                          as.data.frame(geksSplices))

geksSplices %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

geksSplices %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "GEKS Indexes Using Different Splices 
                for Seven Kinds of Vegetables")

```

### Using Different Bilateral Indexes

```{r geksBilaterals, fig.width=7, fig.height=5}

bilaterals <- c("fisher", "tornqvist", "walsh", "jevons")

geksBilaterals <- list()
for(bilateral in bilaterals){
  
  geksBilaterals[[bilateral]] <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                                                      pvar = "price",
                                                      qvar = "quantity",
                                                      prodID = "prodID",
                                                      pervar = "month",
                                                      indexMethod = bilateral,
                                                      window = 13,
                                                      splice = "mean")
  
}

geksBilaterals <- data.frame(date = unique(IsraeliCPI$vegetables$date), 
                             as.data.frame(geksBilaterals))

geksBilaterals %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

geksBilaterals %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "GEKS Indexes Using Different Bilateral Indexes 
                for Seven Kinds of Vegetables")

```

### Using the intersection-GEKS (intGEKS) method

```{r intgeks, fig.width=7, fig.height=5}

# assuming the mean splice
geks <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                             pvar = "price",
                             qvar = "quantity",
                             prodID = "prodID",
                             pervar = "month",
                             indexMethod = "fisher",
                             window = 13,
                             splice = "mean")

intgeks <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                                pvar = "price",
                                qvar = "quantity",
                                prodID = "prodID",
                                pervar = "month",
                                indexMethod = bilateral,
                                window = 13,
                                splice = "mean",
                                intGEKS = TRUE)

geksFrame <- data.frame(date = unique(IsraeliCPI$vegetables$date),
                        geks,
                        intgeks)

geksFrame %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

geksFrame %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "GEKS and intGEKS Indexes for Seven Kinds of Vegetables")

```

## Geary-Khamis Indexes 

### Using Different Splicing Methods

```{r gkSplices, fig.width=7, fig.height=5}

splices <- c("movement", "half", "window", "mean", "fbew", "fbmw")

gkSplices <- list()
for(splice in splices){
  
  gkSplices[[splice]] <- IndexNumR::GKIndex(IsraeliCPI$vegetables, 
                                            pvar = "price",
                                            qvar = "quantity",
                                            prodID = "prodID",
                                            pervar = "month",
                                            window = 13,
                                            splice = splice)
  
}

gkSplices <- data.frame(date = unique(IsraeliCPI$vegetables$date), 
                        as.data.frame(gkSplices))

gkSplices %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

gkSplices %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "Geary-Khamis Indexes Using Different Splices 
                for Seven Kinds of Vegetables")

```

## Weighted Time-Product-Dummy Indexes 

### Using Different Splicing Methods

```{r wtpdSplices, fig.width=7, fig.height=5}

splices <- c("movement", "half", "window", "mean", "fbew", "fbmw")

wtpdSplices <- list()
for(splice in splices){
  
  wtpdSplices[[splice]] <- IndexNumR::WTPDIndex(IsraeliCPI$vegetables, 
                                                pvar = "price",
                                                qvar = "quantity",
                                                prodID = "prodID",
                                                pervar = "month",
                                                window = 13,
                                                splice = splice)
  
}

wtpdSplices <- data.frame(date = unique(IsraeliCPI$vegetables$date), 
                          as.data.frame(wtpdSplices))

wtpdSplices %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

wtpdSplices %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "Weighted Time-Product-Dummy Indexes Using Different Splices 
                for Seven Kinds of Vegetables")

```

## A comparison of multilateral methods

```{r multi, fig.width=7, fig.height=5}

geks <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                             pvar = "price",
                             qvar = "quantity",
                             prodID = "prodID",
                             pervar = "month",
                             indexMethod = "fisher",
                             window = 13,
                             splice = "mean")

ccdi <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                             pvar = "price",
                             qvar = "quantity",
                             prodID = "prodID",
                             pervar = "month",
                             indexMethod = "tornqvist",
                             window = 13,
                             splice = "mean")

gk <- IndexNumR::GKIndex(IsraeliCPI$vegetables, 
                         pvar = "price",
                         qvar = "quantity",
                         prodID = "prodID",
                         pervar = "month",
                         window = 13,
                         splice = "mean")

wtpd <- IndexNumR::WTPDIndex(IsraeliCPI$vegetables, 
                             pvar = "price",
                             qvar = "quantity",
                             prodID = "prodID",
                             pervar = "month",
                             window = 13,
                             splice = "mean")

multis <- data.frame(date = unique(IsraeliCPI$vegetables$date),
                     geks = geks,
                     ccdi = ccdi,
                     gk = gk,
                     wtpd = wtpd)

multis %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

multis %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "Multilateral index numbers for Seven Kinds of Vegetables")

```

## Similarity-linked indexes

```{r simi, fig.width=7, fig.height=5}

similarityMethods <- c("plspread", "asymplinear", "logquadratic", "predictedshare")

# assume a Fisher index 
monthOnMonth <- list()
for(method in similarityMethods){
  monthOnMonth[[method]] <- IndexNumR::priceIndex(IsraeliCPI$vegetables, 
                                                             pvar = "price",
                                                             qvar = "quantity",
                                                             prodID = "prodID",
                                                             pervar = "month",
                                                             indexMethod = "laspeyres",
                                                             output = "chained",
                                                             chainMethod = method)
}

# chained Fisher index for comparison
fisher <- IndexNumR::priceIndex(IsraeliCPI$vegetables, 
                                pvar = "price",
                                qvar = "quantity",
                                prodID = "prodID",
                                pervar = "month",
                                indexMethod = "fisher",
                                output = "chained")

# full window transitive GEKS for comparison
geksFull <- IndexNumR::GEKSIndex(IsraeliCPI$vegetables, 
                             pvar = "price",
                             qvar = "quantity",
                             prodID = "prodID",
                             pervar = "month",
                             indexMethod = "fisher",
                             window = max(IsraeliCPI$vegetables$month))

monthOnMonth <- data.frame(date = unique(IsraeliCPI$vegetables$date), 
                           as.data.frame(monthOnMonth),
                           fisher,
                           GEKS = geksFull) 

monthOnMonth %>% 
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

monthOnMonth %>%
  tidyr::pivot_longer(-date, names_to = "method", values_to = "indexValues") %>%
  ggplot2::ggplot(ggplot2::aes(x = date, y = indexValues, colour = method)) +
  ggplot2::geom_line() +
  ggplot2::labs(y = "", x = "", title = "Similarity Linked Price Indexes for Seven Kinds of Vegetables")

```

### Similarity link periods for different similarity measures

```{r linkPeriods}

linkPeriods <- list()

for(method in similarityMethods){
  
  linkPeriods[[method]] <- IndexNumR::maximumSimilarityLinks(
    IndexNumR::relativeDissimilarity(IsraeliCPI$vegetables, 
                                     pvar = "price",
                                     qvar = "quantity",
                                     prodID = "prodID",
                                     pervar = "month",
                                     similarityMethod = method)
  )$x0
}

linkFrame <- data.frame(period = unique(IsraeliCPI$vegetables$month),
                        as.data.frame(linkPeriods))

linkFrame %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"))

```

# Year-over-year indexes

```{r yoy, fig.width=7, fig.height=5}

yoyIndexes <- IndexNumR::yearOverYearIndexes(freq = "monthly", 
                                             indexFunction = "priceIndex",
                                             indexArgs = list(x = IndexNumR::IsraeliCPI$vegetables,
                                                              pvar = "price",
                                                              qvar = "quantity",
                                                              prodID = "prodID",
                                                              pervar = "month",
                                                              indexMethod = "fisher",
                                                              output = "chained"))

monthLabels <- c("January", "February", "March", "April", "May", "June", "July",
                       "August", "September", "October", "November", "December")
names(yoyIndexes) <- monthLabels

yoyFrame <- dplyr::bind_rows(yoyIndexes, .id = "Month")

yoyFrame %>% ggplot2::ggplot(ggplot2::aes(x=time, y=prices)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(vars(factor(yoyFrame$Month, levels = monthLabels)))

```
